---
title: NetBox Integration
description: NetBox からネットワーク構成を取得し、Shumoku ダイアグラムを自動生成
---

NetBox からネットワーク構成を取得し、Shumoku ダイアグラムを自動生成します。

## インストール

<Tabs items={['npm', 'yarn', 'pnpm', 'bun']}>
  <Tab value="npm">
    ```bash
    npm install @shumoku/netbox
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    yarn add @shumoku/netbox
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    pnpm add @shumoku/netbox
    ```
  </Tab>
  <Tab value="bun">
    ```bash
    bun add @shumoku/netbox
    ```
  </Tab>
</Tabs>

## CLI での使用

コマンドラインから NetBox データを Shumoku YAML に変換できます。

```bash
# 基本的な使い方
npx netbox-to-shumoku --url https://netbox.example.com --token YOUR_API_TOKEN

# ファイルに出力
npx netbox-to-shumoku --url https://netbox.example.com --token YOUR_API_TOKEN -o network.yaml

# サイトでフィルタリング
npx netbox-to-shumoku --url https://netbox.example.com --token YOUR_API_TOKEN --site tokyo-dc
```

### CLI オプション

**接続オプション:**
| オプション | 説明 |
|-----------|------|
| `--url, -u` | NetBox の URL（必須、または NETBOX_URL 環境変数） |
| `--token, -t` | API トークン（必須、または NETBOX_TOKEN 環境変数） |

**出力オプション:**
| オプション | 説明 |
|-----------|------|
| `--output, -o` | 出力ファイル（.yaml または .svg、デフォルト: topology.yaml） |
| `--theme` | テーマ: light または dark |

**フィルタリングオプション:**
| オプション | 説明 |
|-----------|------|
| `--site, -s` | サイト slug でフィルタリング |
| `--role, -r` | デバイスロール slug でフィルタリング |
| `--status` | ステータスでフィルタリング（active, planned, staged, failed, offline） |
| `--tag` | タグ slug でフィルタリング |

**表示オプション:**
| オプション | 説明 |
|-----------|------|
| `--group-by, -g` | グループ化方法: tag, site, location, prefix, none（デフォルト: tag） |
| `--no-ports` | ポート名をリンクに表示しない |
| `--no-colors` | ケーブルタイプによる色分けをしない |
| `--color-by-status` | デバイスをステータスで色分け |

## ライブラリとしての使用

### 基本的な使い方

```typescript
import { NetBoxClient, convertToShumoku } from '@shumoku/netbox'
import { HierarchicalLayoutEngine, SvgRenderer } from '@shumoku/core'

// NetBox クライアントを作成
const client = new NetBoxClient({
  url: 'https://netbox.example.com',
  token: 'your-api-token'
})

// デバイスとケーブルを取得
const devices = await client.getDevices()
const cables = await client.getCables()

// Shumoku NetworkGraph に変換
const graph = convertToShumoku({ devices, cables })

// レイアウトとレンダリング
const engine = new HierarchicalLayoutEngine()
const layout = await engine.layout(graph)

const renderer = new SvgRenderer()
const svg = renderer.render(layout)
```

### サイト情報を含める

```typescript
const devices = await client.getDevices()
const cables = await client.getCables()
const sites = await client.getSites()

const graph = convertToShumoku({
  devices,
  cables,
  sites  // サイトを subgraph として変換
})
```

### フィルタリング

```typescript
// 特定のサイトのデバイスのみ取得
const devices = await client.getDevices({
  site: 'tokyo-dc'
})

// 特定のロールのデバイスのみ取得
const devices = await client.getDevices({
  role: 'core-router'
})

// 複数条件
const devices = await client.getDevices({
  site: 'tokyo-dc',
  role: 'core-router',
  status: 'active'
})
```

## API Reference

### NetBoxClient

```typescript
interface NetBoxClientOptions {
  url: string      // NetBox の URL
  token: string    // API トークン
}

const client = new NetBoxClient(options)
```

#### getDevices

```typescript
interface DeviceFilter {
  site?: string
  role?: string
  status?: 'active' | 'planned' | 'staged' | 'failed' | 'offline'
  manufacturer?: string
  model?: string
}

client.getDevices(filter?: DeviceFilter): Promise<NetBoxDevice[]>
```

#### getCables

```typescript
client.getCables(): Promise<NetBoxCable[]>
```

#### getSites

```typescript
client.getSites(): Promise<NetBoxSite[]>
```

### convertToNetworkGraph

NetBox データを Shumoku NetworkGraph に変換します。

```typescript
import { convertToNetworkGraph } from '@shumoku/netbox'

const graph = convertToNetworkGraph(
  deviceResponse,
  interfaceResponse,
  cableResponse,
  options
)
```

#### ConverterOptions

```typescript
interface ConverterOptions {
  // カスタムタグマッピング（デフォルトとマージ）
  tagMapping?: Record<string, TagMapping>

  // テーマ
  theme?: 'light' | 'dark'

  // ポート名をリンクに表示
  showPorts?: boolean  // default: true

  // VLAN 情報をリンクに表示
  showVlans?: boolean

  // ケーブルタイプで色分け
  colorByCableType?: boolean  // default: true

  // デバイスのグループ化方法
  groupBy?: 'tag' | 'site' | 'location' | 'prefix' | 'none'

  // デバイスロールをタイプ推測に使用
  useRoleForType?: boolean  // default: true

  // ステータスで色分け
  colorByStatus?: boolean

  // 仮想マシンを含める
  includeVMs?: boolean

  // VMをクラスタでグループ化
  groupVMsByCluster?: boolean
}
```

#### 使用例

```typescript
const graph = convertToNetworkGraph(
  deviceResp,
  interfaceResp,
  cableResp,
  {
    groupBy: 'site',
    colorByCableType: true,
    colorByStatus: true,
    showPorts: true,
  }
)
```

## 視覚化機能

### 帯域幅の可視化

インターフェースの `speed` フィールドから帯域幅を自動検出し、線の太さで表現します。

| NetBox speed (kbps) | Shumoku bandwidth | 視覚化 |
|---------------------|-------------------|--------|
| 1,000,000 | 1G | 1本線 |
| 10,000,000 | 10G | 2本線 |
| 25,000,000 | 25G | 3本線 |
| 40,000,000 | 40G | 4本線 |
| 100,000,000+ | 100G | 5本線 |

### VLAN の可視化

インターフェースの `tagged_vlans` と `untagged_vlan` から VLAN 情報を収集し、リンクに設定します。

- 両端インターフェースの VLAN を統合
- VLAN ID に基づいた色分け
- トランクリンクの識別

### ケーブルタイプによる色分け

`colorByCableType: true` で、ケーブル種別に応じた色と線種を適用します。

| ケーブルタイプ | 色 | 線種 |
|---------------|-----|------|
| SMF (シングルモード) | 黄色 | 実線 |
| MMF-OM3 | 緑 | 実線 |
| MMF-OM4 | シアン | 実線 |
| Cat6 | 青 | 実線 |
| Cat6a | 紫 | 実線 |
| DAC (パッシブ) | オレンジ | 破線 |
| DAC (アクティブ) | 赤 | 破線 |
| AOC | ピンク | 破線 |

### デバイスステータスの可視化

`colorByStatus: true` で、デバイスの状態に応じたスタイルを適用します。

| ステータス | スタイル |
|-----------|---------|
| active | デフォルト |
| planned | 破線ボーダー、グレー、半透明 |
| staged | 黄色背景 |
| failed | 赤背景 |
| offline | グレー、半透明 |
| inventory | 青背景、破線 |
| decommissioning | オレンジ背景、破線 |

### グループ化オプション

`groupBy` でデバイスのグループ化方法を指定します。

| 値 | 説明 |
|----|------|
| `tag` | NetBox タグでグループ化（デフォルト） |
| `site` | サイトでグループ化 |
| `location` | ロケーションでグループ化 |
| `prefix` | IP プレフィックス（/16）でグループ化 |
| `none` | グループ化しない |

## NetBox のセットアップ

### API トークンの取得

1. NetBox にログイン
2. 右上のユーザーメニュー → **API Tokens**
3. **Add a token** をクリック
4. 必要な権限を設定してトークンを作成

### 必要な権限

読み取り専用の場合、以下の権限が必要です：

- `dcim.view_device`
- `dcim.view_cable`
- `dcim.view_site`
- `dcim.view_interface`

## データマッピング

NetBox のデータは以下のように Shumoku に変換されます：

| NetBox | Shumoku |
|--------|---------|
| Device | Node |
| Cable | Link |
| Site | Subgraph |
| Interface | Port |
| Device Role | type の推測に使用 |

### デバイスタイプの自動推測

NetBox の `device_role` から Shumoku の `type` を自動推測します：

| NetBox Device Role | Shumoku Type |
|-------------------|--------------|
| `router`, `core-router` | `router` |
| `switch`, `access-switch` | `l2-switch` |
| `l3-switch`, `distribution-switch` | `l3-switch` |
| `firewall` | `firewall` |
| `server`, `compute` | `server` |
| `access-point`, `wireless` | `access-point` |
| `load-balancer` | `load-balancer` |

## トラブルシューティング

### 接続エラー

```
Error: Failed to connect to NetBox
```

- URL が正しいか確認
- API トークンが有効か確認
- ネットワーク接続を確認

### 権限エラー

```
Error: 403 Forbidden
```

- API トークンの権限を確認
- 必要な権限が付与されているか確認

### デバイスが表示されない

- デバイスのステータスが `active` か確認
- フィルタ条件を確認
- NetBox でデバイスが正しく登録されているか確認
