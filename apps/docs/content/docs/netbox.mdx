---
title: NetBox Integration
description: NetBox からネットワーク構成を取得し、Shumoku ダイアグラムを自動生成
---

NetBox からネットワーク構成を取得し、Shumoku ダイアグラムを自動生成します。

## インストール

<Tabs items={['npm', 'yarn', 'pnpm', 'bun']}>
  <Tab value="npm">
    ```bash
    npm install @shumoku/netbox
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    yarn add @shumoku/netbox
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    pnpm add @shumoku/netbox
    ```
  </Tab>
  <Tab value="bun">
    ```bash
    bun add @shumoku/netbox
    ```
  </Tab>
</Tabs>

## CLI での使用

コマンドラインから NetBox データを Shumoku YAML に変換できます。

<Tabs items={['npx', 'yarn', 'pnpm', 'bun']}>
  <Tab value="npx">
    ```bash
    # 基本的な使い方（環境変数で認証）
    export NETBOX_URL=https://netbox.example.com
    export NETBOX_TOKEN=YOUR_API_TOKEN

    # インタラクティブHTML出力
    npx netbox-to-shumoku -f html -o network

    # フォーマットを拡張子から自動判定
    npx netbox-to-shumoku -o network.svg

    # サイトでフィルタリング
    npx netbox-to-shumoku --site tokyo-dc -f html
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    export NETBOX_URL=https://netbox.example.com
    export NETBOX_TOKEN=YOUR_API_TOKEN

    # インタラクティブHTML出力
    yarn dlx netbox-to-shumoku -f html -o network

    # フォーマットを拡張子から自動判定
    yarn dlx netbox-to-shumoku -o network.svg
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    export NETBOX_URL=https://netbox.example.com
    export NETBOX_TOKEN=YOUR_API_TOKEN

    # インタラクティブHTML出力
    pnpm dlx netbox-to-shumoku -f html -o network

    # フォーマットを拡張子から自動判定
    pnpm dlx netbox-to-shumoku -o network.svg
    ```
  </Tab>
  <Tab value="bun">
    ```bash
    export NETBOX_URL=https://netbox.example.com
    export NETBOX_TOKEN=YOUR_API_TOKEN

    # インタラクティブHTML出力
    bunx netbox-to-shumoku -f html -o network

    # フォーマットを拡張子から自動判定
    bunx netbox-to-shumoku -o network.svg
    ```
  </Tab>
</Tabs>

### CLI オプション

**接続オプション:**
| オプション | 説明 |
|-----------|------|
| `--url, -u` | NetBox の URL（必須、または NETBOX_URL 環境変数） |
| `--token, -t` | API トークン（必須、または NETBOX_TOKEN 環境変数） |

**出力オプション:**
| オプション | 説明 |
|-----------|------|
| `--format, -f` | 出力形式: yaml, json, svg, html（デフォルト: 拡張子から自動判定） |
| `--output, -o` | 出力ファイル名（デフォルト: topology） |
| `--theme` | テーマ: light または dark |

**出力形式:**
| 形式 | 説明 |
|------|------|
| `yaml` | YAML定義ファイル（他のツールで利用可能） |
| `json` | NetworkGraph JSON（他のAPIと統合可能） |
| `svg` | 静的SVG画像 |
| `html` | インタラクティブHTML（ツールチップ、パン/ズーム対応） |

**フィルタリングオプション:**
| オプション | 説明 |
|-----------|------|
| `--site, -s` | サイト slug でフィルタリング |
| `--role, -r` | デバイスロール slug でフィルタリング |
| `--status` | ステータスでフィルタリング（active, planned, staged, failed, offline） |
| `--tag` | タグ slug でフィルタリング |

**表示オプション:**
| オプション | 説明 |
|-----------|------|
| `--group-by, -g` | グループ化方法: tag, site, location, prefix, none（デフォルト: tag） |
| `--no-ports` | ポート名をリンクに表示しない |
| `--no-colors` | ケーブルタイプによる色分けをしない |
| `--color-by-status` | デバイスをステータスで色分け |
| `--legend` | 凡例を表示（SVG/HTML 出力時） |

### JSON 出力と統合ワークフロー

NetBox データを JSON で出力し、他のデータソースと統合できます。

<Tabs items={['npx', 'yarn', 'pnpm', 'bun']}>
  <Tab value="npx">
    ```bash
    # Step 1: NetBox から JSON エクスポート
    npx netbox-to-shumoku -f json -o netbox.json

    # Step 2: 独自スクリプトで他のAPIデータとマージ
    node merge-data.js netbox.json custom-api.json > merged.json

    # Step 3: マージした JSON からダイアグラム生成
    npx shumoku render merged.json -o diagram.html
    ```
  </Tab>
  <Tab value="yarn">
    ```bash
    yarn dlx netbox-to-shumoku -f json -o netbox.json
    node merge-data.js netbox.json custom-api.json > merged.json
    yarn dlx shumoku render merged.json -o diagram.html
    ```
  </Tab>
  <Tab value="pnpm">
    ```bash
    pnpm dlx netbox-to-shumoku -f json -o netbox.json
    node merge-data.js netbox.json custom-api.json > merged.json
    pnpm dlx shumoku render merged.json -o diagram.html
    ```
  </Tab>
  <Tab value="bun">
    ```bash
    bunx netbox-to-shumoku -f json -o netbox.json
    node merge-data.js netbox.json custom-api.json > merged.json
    bunx shumoku render merged.json -o diagram.html
    ```
  </Tab>
</Tabs>

`shumoku render` コマンドは `@shumoku/renderer` パッケージに含まれています。

```bash
# shumoku render の使い方
shumoku render <input.json> [options]

# オプション
#   -f, --format <type>  出力形式: svg, html（デフォルト: 拡張子から自動判定）
#   -o, --output <file>  出力ファイル名（デフォルト: output.svg）
#   --theme <theme>      テーマ: light または dark
```

## ライブラリとしての使用

### 基本的な使い方

```typescript
import { NetBoxClient, convertToShumoku } from '@shumoku/netbox'
import { HierarchicalLayoutEngine, SvgRenderer } from '@shumoku/core'

// NetBox クライアントを作成
const client = new NetBoxClient({
  url: 'https://netbox.example.com',
  token: 'your-api-token'
})

// デバイスとケーブルを取得
const devices = await client.getDevices()
const cables = await client.getCables()

// Shumoku NetworkGraph に変換
const graph = convertToShumoku({ devices, cables })

// レイアウトとレンダリング
const engine = new HierarchicalLayoutEngine()
const layout = await engine.layout(graph)

const renderer = new SvgRenderer()
const svg = renderer.render(layout)
```

### サイト情報を含める

```typescript
const devices = await client.getDevices()
const cables = await client.getCables()
const sites = await client.getSites()

const graph = convertToShumoku({
  devices,
  cables,
  sites  // サイトを subgraph として変換
})
```

### フィルタリング

```typescript
// 特定のサイトのデバイスのみ取得
const devices = await client.getDevices({
  site: 'tokyo-dc'
})

// 特定のロールのデバイスのみ取得
const devices = await client.getDevices({
  role: 'core-router'
})

// 複数条件
const devices = await client.getDevices({
  site: 'tokyo-dc',
  role: 'core-router',
  status: 'active'
})
```

## API Reference

### NetBoxClient

```typescript
interface NetBoxClientOptions {
  url: string      // NetBox の URL
  token: string    // API トークン
}

const client = new NetBoxClient(options)
```

#### getDevices

```typescript
interface DeviceFilter {
  site?: string
  role?: string
  status?: 'active' | 'planned' | 'staged' | 'failed' | 'offline'
  manufacturer?: string
  model?: string
}

client.getDevices(filter?: DeviceFilter): Promise<NetBoxDevice[]>
```

#### getCables

```typescript
client.getCables(): Promise<NetBoxCable[]>
```

#### getSites

```typescript
client.getSites(): Promise<NetBoxSite[]>
```

### convertToNetworkGraph

NetBox データを Shumoku NetworkGraph に変換します。

```typescript
import { convertToNetworkGraph } from '@shumoku/netbox'

const graph = convertToNetworkGraph(
  deviceResponse,
  interfaceResponse,
  cableResponse,
  options
)
```

#### ConverterOptions

```typescript
interface ConverterOptions {
  // カスタムタグマッピング（デフォルトとマージ）
  tagMapping?: Record<string, TagMapping>

  // テーマ
  theme?: 'light' | 'dark'

  // ポート名をリンクに表示
  showPorts?: boolean  // default: true

  // VLAN 情報をリンクに表示
  showVlans?: boolean

  // ケーブルタイプで色分け
  colorByCableType?: boolean  // default: true

  // デバイスのグループ化方法
  groupBy?: 'tag' | 'site' | 'location' | 'prefix' | 'none'

  // デバイスロールをタイプ推測に使用
  useRoleForType?: boolean  // default: true

  // ステータスで色分け
  colorByStatus?: boolean

  // 仮想マシンを含める
  includeVMs?: boolean

  // VMをクラスタでグループ化
  groupVMsByCluster?: boolean

  // 凡例を表示
  legend?: boolean | LegendSettings
}
```

#### 使用例

```typescript
const graph = convertToNetworkGraph(
  deviceResp,
  interfaceResp,
  cableResp,
  {
    groupBy: 'site',
    colorByCableType: true,
    colorByStatus: true,
    showPorts: true,
    legend: true,  // 凡例を表示
  }
)

// 凡例をカスタマイズ
const graph = convertToNetworkGraph(
  deviceResp,
  interfaceResp,
  cableResp,
  {
    legend: {
      enabled: true,
      position: 'bottom-right',  // 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'
      showDeviceTypes: true,
      showBandwidth: true,
      showCableTypes: true,
      showVlans: false,
    }
  }
)
```

## 視覚化機能

### 帯域幅の可視化

インターフェースの `speed` フィールドから帯域幅を自動検出し、線の太さで表現します。

| NetBox speed (kbps) | Shumoku bandwidth | 視覚化 |
|---------------------|-------------------|--------|
| 1,000,000 | 1G | 1本線 |
| 10,000,000 | 10G | 2本線 |
| 25,000,000 | 25G | 3本線 |
| 40,000,000 | 40G | 4本線 |
| 100,000,000+ | 100G | 5本線 |

### VLAN の可視化

インターフェースの `tagged_vlans` と `untagged_vlan` から VLAN 情報を収集し、リンクに設定します。

- 両端インターフェースの VLAN を統合
- VLAN ID に基づいた色分け
- トランクリンクの識別

### ケーブルタイプによる色分け

`colorByCableType: true` で、ケーブル種別に応じた色と線種を適用します。

| ケーブルタイプ | 色 | 線種 |
|---------------|-----|------|
| SMF (シングルモード) | 黄色 | 実線 |
| MMF-OM3 | 緑 | 実線 |
| MMF-OM4 | シアン | 実線 |
| Cat6 | 青 | 実線 |
| Cat6a | 紫 | 実線 |
| DAC (パッシブ) | オレンジ | 破線 |
| DAC (アクティブ) | 赤 | 破線 |
| AOC | ピンク | 破線 |

### デバイスステータスの可視化

`colorByStatus: true` で、デバイスの状態に応じたスタイルを適用します。

| ステータス | スタイル |
|-----------|---------|
| active | デフォルト |
| planned | 破線ボーダー、グレー、半透明 |
| staged | 黄色背景 |
| failed | 赤背景 |
| offline | グレー、半透明 |
| inventory | 青背景、破線 |
| decommissioning | オレンジ背景、破線 |

### グループ化オプション

`groupBy` でデバイスのグループ化方法を指定します。

| 値 | 説明 |
|----|------|
| `tag` | NetBox タグでグループ化（デフォルト） |
| `site` | サイトでグループ化 |
| `location` | ロケーションでグループ化 |
| `prefix` | IP プレフィックス（/16）でグループ化 |
| `none` | グループ化しない |

### 凡例（Legend）

`legend` オプションでダイアグラムに凡例を表示できます。

```typescript
// シンプルに有効化
{ legend: true }

// カスタマイズ
{
  legend: {
    enabled: true,
    position: 'top-right',     // 表示位置
    showDeviceTypes: true,     // デバイスタイプを表示
    showBandwidth: true,       // 帯域幅を表示
    showCableTypes: true,      // ケーブルタイプを表示
    showVlans: false,          // VLAN を表示
  }
}
```

| 設定 | 説明 | デフォルト |
|------|------|-----------|
| `enabled` | 凡例を表示 | `true` |
| `position` | 表示位置（`top-left`, `top-right`, `bottom-left`, `bottom-right`） | `top-right` |
| `showDeviceTypes` | デバイスタイプアイコンを表示 | `true` |
| `showBandwidth` | 帯域幅インジケーターを表示 | `true` |
| `showCableTypes` | ケーブルタイプの色を表示 | `true` |
| `showVlans` | VLAN の色を表示 | `false` |

## 階層型出力

複数拠点のネットワークを階層型YAMLに変換できます。

```typescript
import { convertToHierarchicalYaml } from '@shumoku/netbox'

const result = convertToHierarchicalYaml(
  deviceResp,
  interfaceResp,
  cableResp,
  {
    hierarchical: true,
    hierarchyDepth: 'location',  // 'site' | 'location' | 'rack'
    fileBasePath: './',
    theme: 'light',
  }
)

// 結果
console.log(result.main)           // main.yaml の内容
console.log(result.files)          // Map<locationId, yamlContent>
console.log(result.crossLinks)     // 拠点間リンク一覧
```

### HierarchicalConverterOptions

```typescript
interface HierarchicalConverterOptions extends ConverterOptions {
  // 階層型出力を有効化
  hierarchical?: boolean

  // 階層の深さ
  hierarchyDepth?: 'site' | 'location' | 'rack'

  // ファイル参照のベースパス
  fileBasePath?: string  // default: './'
}
```

| hierarchyDepth | 説明 |
|----------------|------|
| `site` | サイト単位でファイル分割 |
| `location` | ロケーション単位（デフォルト） |
| `rack` | ラック単位（最も細かい） |

### 出力例

```yaml
# main.yaml
name: "Network Overview"

subgraphs:
  - id: tokyo-dc
    label: "Tokyo DC"
    file: "./tokyo-dc.yaml"
  - id: osaka-dc
    label: "Osaka DC"
    file: "./osaka-dc.yaml"

links:
  # 拠点間リンクはデバイスを直接参照
  - from:
      node: tokyo-router
      port: wan1
    to:
      node: osaka-router
      port: wan1
    bandwidth: 10G
```

---

## NetBox のセットアップ

### API トークンの取得

1. NetBox にログイン
2. 右上のユーザーメニュー → **API Tokens**
3. **Add a token** をクリック
4. 必要な権限を設定してトークンを作成

### 必要な権限

読み取り専用の場合、以下の権限が必要です：

- `dcim.view_device`
- `dcim.view_cable`
- `dcim.view_site`
- `dcim.view_interface`

## データマッピング

NetBox のデータは以下のように Shumoku に変換されます：

| NetBox | Shumoku |
|--------|---------|
| Device | Node |
| Cable | Link |
| Site | Subgraph |
| Interface | Port |
| Device Role | type の推測に使用 |

### デバイスタイプの自動推測

NetBox の `device_role` から Shumoku の `type` を自動推測します：

| NetBox Device Role | Shumoku Type |
|-------------------|--------------|
| `router`, `core-router` | `router` |
| `switch`, `access-switch` | `l2-switch` |
| `l3-switch`, `distribution-switch` | `l3-switch` |
| `firewall` | `firewall` |
| `server`, `compute` | `server` |
| `access-point`, `wireless` | `access-point` |
| `load-balancer` | `load-balancer` |

## GitHub Actions でのデプロイ

GitHub Actions を使って NetBox から自動生成した HTML を GitHub Pages にデプロイできます。

```yaml
# .github/workflows/network-diagram.yml
name: Update Network Diagram

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日 AM 9:00 (JST)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Generate diagram
        run: |
          npx netbox-to-shumoku \
            -u ${{ secrets.NETBOX_URL }} \
            -t ${{ secrets.NETBOX_TOKEN }} \
            -f html -o index

      - uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - uses: actions/deploy-pages@v4
```

**設定:**
1. Settings → Secrets に `NETBOX_URL` と `NETBOX_TOKEN` を追加
2. Settings → Pages → Source を "GitHub Actions" に設定

## トラブルシューティング

### 接続エラー

```
Error: Failed to connect to NetBox
```

- URL が正しいか確認
- API トークンが有効か確認
- ネットワーク接続を確認

### 権限エラー

```
Error: 403 Forbidden
```

- API トークンの権限を確認
- 必要な権限が付与されているか確認

### デバイスが表示されない

- デバイスのステータスが `active` か確認
- フィルタ条件を確認
- NetBox でデバイスが正しく登録されているか確認
